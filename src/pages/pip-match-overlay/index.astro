---
import SampleLayout from "@layouts/SampleLayout.astro";
import { samples } from "@utils/samples";

const sample = samples.find((item) => item.path === "/pip-match-overlay");
---

<style lang="scss">
  .sample-container {
    #overlay {
      width: 35%;
      bottom: 0;
      right: 0;
    }
  }
</style>

<div class="sample-container">
  <SampleLayout sample={sample} />
</div>

<script class="code">
  var CAPTION_URL =
      "https://d1lytwcb2ho7l3.cloudfront.net/soccer/dash/output.mpd",
    video,
    player;

  function init() {
    var url = CAPTION_URL,
      TTMLRenderingDiv;

    video = document.querySelector("#main-video");
    TTMLRenderingDiv = document.querySelector("#ttml-rendering-div");
    OverlayRenderingDiv = document.querySelector("#overlay");

    player = dashjs.MediaPlayer().create();
    player.initialize(video, url, true);
    player.attachTTMLRenderingDiv(TTMLRenderingDiv);
    attachOverlayRenderingDiv(OverlayRenderingDiv);
  }

  function attachOverlayRenderingDiv(overlayElement) {
    var overlayIframe = document.createElement("iframe");
    overlayIframe.id = "iframe-overlay";
    overlayIframe.src = "pip-match-overlay/tennis-match";
    overlayIframe.frameBorder = 0;
    overlayElement.appendChild(overlayIframe);

    player.on(dashjs.MediaPlayer.events.PLAYBACK_TIME_UPDATED, function (e) {
      sendMessageToIframe(overlayIframe, {
        event: "timeupdate",
        currentTime: e.time,
      });
    });

    player.on(dashjs.MediaPlayer.events.PLAYBACK_STARTED, function () {
      sendMessageToIframe(overlayIframe, { event: "playing" });
    });

    player.on(dashjs.MediaPlayer.events.PLAYBACK_PAUSED, function () {
      sendMessageToIframe(overlayIframe, { event: "paused" });
    });
  }

  function sendMessageToIframe(iframe, message) {
    if (iframe && iframe.contentWindow) {
      iframe.contentWindow.postMessage(message, "*");
    }
  }

  init();
</script>
